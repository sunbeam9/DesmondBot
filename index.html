<!DOCTYPE html>
<html>
	<head>
		<title>Desmond Bot OAuth</title>
	</head>
	<body>
		<div id="message">Redirecting... If you can still see this message, please reload the page.</div>
        <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
        <script>

            function generateRandomString() {
                let randomString = '';
                const randomNumber = Math.floor(Math.random() * 10);

                for (let i = 0; i < 20 + randomNumber; i++) {
                    randomString += String.fromCharCode(33 + Math.floor(Math.random() * 94));
                }

                return randomString;
            }

            window.onload = async () => {
                const fragment = new URLSearchParams(window.location.search);
                const [code, state] = [fragment.get('code'), fragment.get('state')];
        
                if (!code) {
                    const state = generateRandomString();
                    localStorage.setItem('oauth-state', state);

                    // get client id and redirect uri from /clientId and /redirectUri
                    const clientId = await axios.get(window.location.origin + '/clientId').then(res => {
                        return res.data.clientId;
                    }).catch(err => {
                        console.error(err);
                    });
                    // log the client id and redirect uri
                    console.log(clientId);

                    const oauthUri = `https://discord.com/api/oauth2/authorize?client_id=${clientId}&redirect_uri=${encodeURIComponent(window.location.href)}&response_type=code&scope=identify%20guilds.members.read%20connections&state=${btoa(state)}`;

                    window.location.href = oauthUri;
                    return;
                }

                const state1 = atob(decodeURIComponent(state));
                if (localStorage.getItem('oauth-state') !== state1) {
                    localStorage.removeItem('oauth-state');
                    document.getElementById('message').innerHTML = 'OAuth state mismatch. Please try again.';
                } else {
                    localStorage.removeItem('oauth-state');

                    // post access code to backend
                    await axios.post(window.location.href, {
                        code: code,
                    }).then(res => {
                        // log status code
                        document.getElementById('message').innerHTML = `Success! You can close this window now.`;
                        window.close();
                    }).catch(err => {
                        console.error(err);
                        document.getElementById('message').innerHTML = `Something went wrong... Please try again.`;
                    });
                }
            };
        </script>
	</body>
</html>